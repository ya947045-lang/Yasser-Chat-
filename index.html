<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#075e54">
    <title>Ø¯Ø±Ø¯Ø´Ø© Ù…ØµØ±ÙŠØ© - ØªØ·Ø¨ÙŠÙ‚ Ø¯Ø±Ø¯Ø´Ø© Ø­Ù‚ÙŠÙ‚ÙŠ</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #075e54, #128c7e);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ */
        .login-container {
            max-width: 400px;
            width: 100%;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .login-header {
            background: #075e54;
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .login-header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .login-body {
            padding: 30px;
        }
        
        .logo {
            text-align: center;
            font-size: 60px;
            margin-bottom: 20px;
            color: #075e54;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .input-group input:focus {
            border-color: #25d366;
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);
        }
        
        .btn {
            background: #25d366;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .btn:hover {
            background: #1da851;
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #25d366;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .message {
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
            display: none;
        }
        
        .message.success {
            background: #e8f7ed;
            color: #25d366;
            border: 1px solid #25d366;
        }
        
        .message.error {
            background: #ffeaea;
            color: #ff3b30;
            border: 1px solid #ff3b30;
        }
        
        /* Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        .app-container {
            max-width: 400px;
            width: 100%;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .app-header {
            background: #075e54;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-header h2 {
            font-size: 18px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: #25d366;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        
        .tabs {
            display: flex;
            background: #f0f0f0;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            color: #666;
        }
        
        .tab.active {
            background: white;
            color: #25d366;
            border-bottom: 2px solid #25d366;
        }
        
        .content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .screen {
            height: 100%;
            display: none;
            flex-direction: column;
        }
        
        .screen.active {
            display: flex;
        }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† */
        .users-container {
            flex: 1;
            overflow-y: auto;
        }
        
        .user-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .user-item:hover {
            background: #f9f9f9;
        }
        
        .user-avatar-item {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            margin-left: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        
        .user-status {
            font-size: 12px;
            color: #25d366;
        }
        
        .user-status.offline {
            color: #999;
        }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© */
        .chat-header {
            background: #075e54;
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .back-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        
        .messages-container {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #e5ddd5;
            display: flex;
            flex-direction: column;
        }
        
        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 10px;
            word-wrap: break-word;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message-bubble.sent {
            background: #dcf8c6;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        
        .message-bubble.received {
            background: white;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .message-text {
            margin-bottom: 5px;
        }
        
        .message-time {
            font-size: 11px;
            color: #999;
            text-align: left;
        }
        
        .message-bubble.sent .message-time {
            text-align: right;
        }
        
        .message-input-container {
            padding: 15px;
            background: #f0f0f0;
            display: flex;
            gap: 10px;
        }
        
        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .send-btn {
            background: #25d366;
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª */
        .chats-container {
            flex: 1;
            overflow-y: auto;
        }
        
        .chat-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .chat-item:hover {
            background: #f9f9f9;
        }
        
        .chat-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            margin-left: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }
        
        .chat-info {
            flex: 1;
        }
        
        .chat-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        
        .chat-last-message {
            color: #666;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-time {
            font-size: 11px;
            color: #999;
        }
        
        .unread-badge {
            background: #25d366;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
        .settings-container {
            padding: 20px;
        }
        
        .user-info-card {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .user-avatar-large {
            width: 80px;
            height: 80px;
            background: #25d366;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: white;
            font-weight: bold;
        }
        
        .user-details {
            margin-bottom: 20px;
        }
        
        .user-details div {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        
        .user-details div:last-child {
            border-bottom: none;
        }
        
        .label {
            color: #666;
        }
        
        .value {
            color: #333;
            font-weight: 500;
        }
        
        /* Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .empty-state i {
            font-size: 50px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        /* Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #25d366;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 1000;
            animation: notificationSlide 0.3s ease;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        @keyframes notificationSlide {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        /* Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ */
        .quick-login {
            text-align: center;
            margin-top: 15px;
            color: #666;
            font-size: 14px;
        }
        
        .quick-login a {
            color: #25d366;
            cursor: pointer;
            font-weight: 500;
        }
        
        /* Ù„Ù„Ø¬ÙˆØ§Ù„ */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }
            
            .login-container,
            .app-container {
                max-width: 100%;
                border-radius: 0;
                height: 100vh;
            }
        }
    </style>
</head>
<body>
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
    <div id="loginScreen" class="login-container">
        <div class="login-header">
            <h1>Ø¯Ø±Ø¯Ø´Ø© Ù…ØµØ±ÙŠØ© Ø­Ù‚ÙŠÙ‚ÙŠØ© ğŸ’¬</h1>
            <p>ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ</p>
        </div>
        
        <div class="login-body">
            <div class="logo">ğŸš€</div>
            
            <div class="input-group">
                <label for="userName">Ù…Ø§ Ø§Ø³Ù…ÙƒØŸ</label>
                <input type="text" id="userName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ..." autofocus>
            </div>
            
            <button class="btn" id="loginBtn" onclick="login()">
                Ø¯Ø®ÙˆÙ„ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚
            </button>
            
            <div class="loading" id="loginLoading">
                <div class="spinner"></div>
                <div>Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...</div>
            </div>
            
            <div class="message" id="loginMessage"></div>
            
            <div class="quick-login">
                Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹: 
                <a onclick="quickLogin('Ø£Ø­Ù…Ø¯')">Ø£Ø­Ù…Ø¯</a> | 
                <a onclick="quickLogin('Ù…Ø­Ù…Ø¯')">Ù…Ø­Ù…Ø¯</a> | 
                <a onclick="quickLogin('Ø³Ø§Ø±Ø©')">Ø³Ø§Ø±Ø©</a>
            </div>
        </div>
    </div>
    
    <!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div id="mainApp" class="app-container" style="display: none;">
        <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
        <div class="app-header">
            <div class="user-avatar" id="userAvatar">?</div>
            <h2 id="appTitle">Ø¯Ø±Ø¯Ø´Ø© Ù…ØµØ±ÙŠØ©</h2>
            <div style="width: 40px;"></div>
        </div>
        
        <!-- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
        <div class="tabs">
            <div class="tab active" data-tab="users" onclick="switchTab('users')">
                ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†
            </div>
            <div class="tab" data-tab="chats" onclick="switchTab('chats')">
                ğŸ’¬ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª
            </div>
            <div class="tab" data-tab="chat" onclick="switchTab('chat')" style="display: none;">
                Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            </div>
            <div class="tab" data-tab="settings" onclick="switchTab('settings')">
                âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            </div>
        </div>
        
        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
        <div class="content">
            <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
            <div id="usersScreen" class="screen active">
                <div class="users-container" id="usersList">
                    <!-- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† ÙŠØ¸Ù‡Ø±ÙˆÙ† Ù‡Ù†Ø§ -->
                </div>
            </div>
            
            <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª -->
            <div id="chatsScreen" class="screen">
                <div class="chats-container" id="chatsList">
                    <!-- Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
                </div>
            </div>
            
            <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
            <div id="chatScreen" class="screen">
                <div class="chat-header">
                    <button class="back-btn" onclick="switchTab('chats')">â†</button>
                    <div id="chatUserName">Ù…Ø­Ø§Ø¯Ø«Ø©</div>
                </div>
                
                <div class="messages-container" id="messagesContainer">
                    <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
                </div>
                
                <div class="message-input-container">
                    <input type="text" class="message-input" id="messageInput" 
                           placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." 
                           onkeypress="if(event.key === 'Enter') sendMessage()">
                    <button class="send-btn" onclick="sendMessage()">â†‘</button>
                </div>
            </div>
            
            <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
            <div id="settingsScreen" class="screen">
                <div class="settings-container">
                    <div class="user-info-card">
                        <div class="user-avatar-large" id="largeUserAvatar">?</div>
                        <h3 id="settingsUserName">Ù…Ø³ØªØ®Ø¯Ù…</h3>
                        <p id="settingsUserId" style="color: #666; font-size: 12px; margin-top: 5px;">Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</p>
                    </div>
                    
                    <div class="user-details">
                        <div>
                            <span class="label">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…ØªØµÙ„ÙˆÙ†:</span>
                            <span class="value" id="onlineCount">0</span>
                        </div>
                        <div>
                            <span class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª:</span>
                            <span class="value" id="chatsCount">0</span>
                        </div>
                        <div>
                            <span class="label">Ø§Ù„Ø­Ø§Ù„Ø©:</span>
                            <span class="value" id="userStatus">ğŸŸ¢ Ù…ØªØµÙ„</span>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="changeName()">
                        âœï¸ ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…
                    </button>
                    
                    <button class="btn btn-secondary" onclick="logout()" style="margin-top: 10px;">
                        ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
    <div class="notification" id="notification"></div>

    <!-- Firebase & App Script -->
    <script>
        // ============================================
        // âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDLm_HUbnNfRv4ZH9u08VQi7pmZzm1GgRk",
            authDomain: "yasser-chat-6c39c.firebaseapp.com",
            projectId: "yasser-chat-6c39c",
            storageBucket: "yasser-chat-6c39c.firebasestorage.app",
            messagingSenderId: "141483029088",
            appId: "1:141483029088:web:18787391e80466f6bbc905"
        };
        
        // ============================================
        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        // ============================================
        let db = null;
        let currentUser = null;
        let currentChat = null;
        let allUsers = [];
        let myChats = [];
        let unsubscribeUsers = null;
        let unsubscribeChats = null;
        let unsubscribeMessages = null;
        
        // ============================================
        // ğŸ”¥ ØªÙ‡ÙŠØ¦Ø© Firebase
        // ============================================
        function initializeFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                console.log("âœ… Firebase Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…");
                return true;
            } catch (error) {
                console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Firebase:", error);
                showMessage('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±', 'error');
                return false;
            }
        }
        
        // ============================================
        // ğŸ› ï¸ Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
        // ============================================
        function showLoading(show) {
            document.getElementById('loginLoading').style.display = show ? 'block' : 'none';
            document.getElementById('loginBtn').style.display = show ? 'none' : 'block';
        }
        
        function showMessage(text, type) {
            const messageDiv = document.getElementById('loginMessage');
            messageDiv.innerHTML = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }
        }
        
        function showNotification(text) {
            const notification = document.getElementById('notification');
            notification.textContent = text;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }
        
        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        function formatTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Ø§Ù„Ø¢Ù†';
            if (diff < 3600000) return `${Math.floor(diff / 60000)} Ø¯Ù‚ÙŠÙ‚Ø©`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)} Ø³Ø§Ø¹Ø©`;
            
            return date.toLocaleDateString('ar-EG', { 
                month: 'short', 
                day: 'numeric' 
            });
        }
        
        // ============================================
        // ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        // ============================================
        async function login() {
            const userName = document.getElementById('userName').value.trim();
            
            if (!userName || userName.length < 2) {
                showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµØ­ÙŠØ­ (Ø­Ø±ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                // ØªÙ‡ÙŠØ¦Ø© Firebase Ø£ÙˆÙ„Ø§Ù‹
                const firebaseConnected = initializeFirebase();
                if (!firebaseConnected) {
                    showLoading(false);
                    showMessage('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error');
                    return;
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Firestore
                try {
                    await db.collection('test').doc('connection').set({
                        test: true,
                        timestamp: new Date().toISOString()
                    });
                    console.log("âœ… Firestore Ù…ØªØµÙ„");
                } catch (firestoreError) {
                    console.warn("âš ï¸ Firestore ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯:", firestoreError.message);
                }
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const userId = localStorage.getItem('userId') || generateUserId();
                const userData = {
                    id: userId,
                    name: userName,
                    isOnline: true,
                    lastSeen: new Date().toISOString(),
                    createdAt: localStorage.getItem('userCreatedAt') || new Date().toISOString()
                };
                
                // Ø­ÙØ¸ ÙÙŠ Firebase
                try {
                    await db.collection('users').doc(userId).set(userData, { merge: true });
                    console.log("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase");
                } catch (error) {
                    console.warn("âš ï¸ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·:", error.message);
                }
                
                // Ø­ÙØ¸ ÙÙŠ localStorage
                localStorage.setItem('currentUser', JSON.stringify(userData));
                localStorage.setItem('userId', userId);
                localStorage.setItem('userCreatedAt', userData.createdAt);
                
                currentUser = userData;
                
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
                showLoading(false);
                
                // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
                showMessage(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${userName}! Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...`, 'success');
                
                // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                setTimeout(() => {
                    startApp();
                }, 1000);
                
            } catch (error) {
                showLoading(false);
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', error);
                showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error');
            }
        }
        
        // ============================================
        // ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        // ============================================
        function startApp() {
            // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
            document.getElementById('loginScreen').style.display = 'none';
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
            document.getElementById('mainApp').style.display = 'flex';
            
            // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            loadUserData();
            
            // Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
            startListening();
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± ØªØ±Ø­ÙŠØ¨ÙŠ
            showNotification(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.name}! ğŸ‰`);
        }
        
        // ============================================
        // ğŸ‘¤ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        // ============================================
        function loadUserData() {
            if (!currentUser) return;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙØ§ØªØ§Ø±
            const initials = getInitials(currentUser.name);
            document.getElementById('userAvatar').textContent = initials;
            document.getElementById('largeUserAvatar').textContent = initials;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù…
            document.getElementById('appTitle').textContent = currentUser.name;
            document.getElementById('settingsUserName').textContent = currentUser.name;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø±Ù
            const shortId = currentUser.id.substring(0, 8) + '...';
            document.getElementById('settingsUserId').textContent = `ID: ${shortId}`;
        }
        
        // ============================================
        // ğŸ‘‚ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
        // ============================================
        function startListening() {
            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            listenToUsers();
            
            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø§Øª
            listenToChats();
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
            setInterval(updateOnlineStatus, 30000);
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
            window.addEventListener('beforeunload', () => {
                if (currentUser) {
                    updateUserStatus(false);
                }
            });
        }
        
        // ============================================
        // ğŸ“¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        // ============================================
        function listenToUsers() {
            if (!db || !currentUser) return;
            
            if (unsubscribeUsers) unsubscribeUsers();
            
            unsubscribeUsers = db.collection('users')
                .where('id', '!=', currentUser.id)
                .onSnapshot(snapshot => {
                    allUsers = [];
                    
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        allUsers.push(user);
                    });
                    
                    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                    updateUsersList();
                    
                    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†
                    const onlineUsers = allUsers.filter(u => u.isOnline);
                    document.getElementById('onlineCount').textContent = onlineUsers.length;
                    
                }, error => {
                    console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:", error);
                });
        }
        
        // ============================================
        // ğŸ“‹ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        // ============================================
        function updateUsersList() {
            const usersList = document.getElementById('usersList');
            
            if (allUsers.length === 0) {
                usersList.innerHTML = `
                    <div class="empty-state">
                        <div>ğŸ‘¥</div>
                        <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø¢Ø®Ø±ÙˆÙ†</p>
                        <p style="font-size: 12px; margin-top: 10px;">Ø§ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø£Ø®Ø±Ù‰ Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</p>
                    </div>
                `;
                return;
            }
            
            usersList.innerHTML = '';
            
            allUsers.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'user-item';
                userElement.onclick = () => startChatWithUser(user);
                
                const initials = getInitials(user.name);
                const status = user.isOnline ? 'ğŸŸ¢ Ù…ØªØµÙ„' : 'âš« ØºÙŠØ± Ù…ØªØµÙ„';
                const statusClass = user.isOnline ? 'user-status' : 'user-status offline';
                
                userElement.innerHTML = `
                    <div class="user-avatar-item">${initials}</div>
                    <div class="user-info">
                        <div class="user-name">${user.name}</div>
                        <div class="${statusClass}">${status}</div>
                    </div>
                `;
                
                usersList.appendChild(userElement);
            });
        }
        
        // ============================================
        // ğŸ’¬ Ø¨Ø¯Ø¡ Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ Ù…Ø³ØªØ®Ø¯Ù…
        // ============================================
        async function startChatWithUser(otherUser) {
            if (!currentUser || !otherUser) return;
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            const chatId = [currentUser.id, otherUser.id].sort().join('_');
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            const existingChat = myChats.find(chat => chat.id === chatId);
            
            if (existingChat) {
                // ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
                openChat(existingChat);
                return;
            }
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©
            const chatData = {
                id: chatId,
                user1: currentUser.id,
                user2: otherUser.id,
                user1Name: currentUser.name,
                user2Name: otherUser.name,
                lastMessage: '',
                lastMessageTime: new Date().toISOString(),
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            try {
                // Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙÙŠ Firebase
                await db.collection('chats').doc(chatId).set(chatData, { merge: true });
                
                // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                const chatForMe = {
                    id: chatId,
                    otherUserId: otherUser.id,
                    otherUserName: otherUser.name,
                    lastMessage: 'Ø¨Ø¯Ø£Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©',
                    lastMessageTime: new Date().toISOString(),
                    unread: 0
                };
                
                myChats.unshift(chatForMe);
                updateChatsList();
                
                // ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
                openChat(chatForMe);
                
                showNotification(`Ø¨Ø¯Ø£Øª Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ ${otherUser.name}`);
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:', error);
                showNotification('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©');
            }
        }
        
        // ============================================
        // ğŸ“¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø§Øª
        // ============================================
        function listenToChats() {
            if (!db || !currentUser) return;
            
            if (unsubscribeChats) unsubscribeChats();
            
            unsubscribeChats = db.collection('chats')
                .where('user1', '==', currentUser.id)
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added' || change.type === 'modified') {
                            const chat = change.doc.data();
                            updateOrAddChat(chat, false);
                        }
                    });
                });
            
            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø§Øª Ø§Ù„ØªÙŠ ÙŠÙƒÙˆÙ† ÙÙŠÙ‡Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… user2
            db.collection('chats')
                .where('user2', '==', currentUser.id)
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added' || change.type === 'modified') {
                            const chat = change.doc.data();
                            updateOrAddChat(chat, true);
                        }
                    });
                });
        }
        
        // ============================================
        // ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø¯Ø´Ø©
        // ============================================
        function updateOrAddChat(chatData, isUser2) {
            const otherUserId = isUser2 ? chatData.user1 : chatData.user2;
            const otherUserName = isUser2 ? chatData.user1Name : chatData.user2Name;
            
            const existingIndex = myChats.findIndex(c => c.id === chatData.id);
            
            const chat = {
                id: chatData.id,
                otherUserId: otherUserId,
                otherUserName: otherUserName,
                lastMessage: chatData.lastMessage || '',
                lastMessageTime: chatData.lastMessageTime || new Date().toISOString(),
                unread: 0
            };
            
            if (existingIndex === -1) {
                // Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø¯Ø´Ø© Ø¬Ø¯ÙŠØ¯Ø©
                myChats.unshift(chat);
            } else {
                // ØªØ­Ø¯ÙŠØ« Ø¯Ø±Ø¯Ø´Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©
                myChats[existingIndex] = chat;
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª
                myChats.sort((a, b) => new Date(b.lastMessageTime) - new Date(a.lastMessageTime));
            }
            
            updateChatsList();
        }
        
        // ============================================
        // ğŸ“‹ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª
        // ============================================
        function updateChatsList() {
            const chatsList = document.getElementById('chatsList');
            document.getElementById('chatsCount').textContent = myChats.length;
            
            if (myChats.length === 0) {
                chatsList.innerHTML = `
                    <div class="empty-state">
                        <div>ğŸ’¬</div>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±Ø¯Ø´Ø§Øª Ø¨Ø¹Ø¯</p>
                        <p style="font-size: 12px; margin-top: 10px;">Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø©</p>
                    </div>
                `;
                return;
            }
            
            chatsList.innerHTML = '';
            
            myChats.forEach(chat => {
                const chatElement = document.createElement('div');
                chatElement.className = 'chat-item';
                chatElement.onclick = () => openChat(chat);
                
                const initials = getInitials(chat.otherUserName);
                const time = formatTime(chat.lastMessageTime);
                
                chatElement.innerHTML = `
                    <div class="chat-avatar">${initials}</div>
                    <div class="chat-info">
                        <div class="chat-name">${chat.otherUserName}</div>
                        <div class="chat-last-message">
                            <span>${chat.lastMessage || 'Ø¨Ø¯Ø£Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©'}</span>
                            <span class="chat-time">${time}</span>
                        </div>
                    </div>
                `;
                
                chatsList.appendChild(chatElement);
            });
        }
        
        // ============================================
        // ğŸ’­ ÙØªØ­ Ù…Ø­Ø§Ø¯Ø«Ø©
        // ============================================
        function openChat(chat) {
            currentChat = chat;
            document.getElementById('chatUserName').textContent = chat.otherUserName;
            switchTab('chat');
            loadMessages(chat.id);
        }
        
        // ============================================
        // ğŸ“© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        // ============================================
        function loadMessages(chatId) {
            if (!db) return;
            
            // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø§Ù„Ø³Ø§Ø¨Ù‚
            if (unsubscribeMessages) unsubscribeMessages();
            
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = '<div class="empty-state"><div>ğŸ“¨</div><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</p></div>';
            
            unsubscribeMessages = db.collection('chats').doc(chatId)
                .collection('messages')
                .orderBy('timestamp', 'asc')
                .limit(50)
                .onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        messagesContainer.innerHTML = `
                            <div class="empty-state">
                                <div>ğŸ’­</div>
                                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯</p>
                                <p style="font-size: 12px; margin-top: 10px;">Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</p>
                            </div>
                        `;
                        return;
                    }
                    
                    messagesContainer.innerHTML = '';
                    
                    snapshot.forEach(doc => {
                        const msg = doc.data();
                        addMessageToUI(msg);
                    });
                    
                    // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„
                    setTimeout(() => {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }, 100);
                    
                }, error => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„:', error);
                    messagesContainer.innerHTML = '<div class="empty-state">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</div>';
                });
        }
        
        // ============================================
        // âœ‰ï¸ Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
        // ============================================
        function addMessageToUI(msg) {
            const messagesContainer = document.getElementById('messagesContainer');
            const isSent = msg.senderId === currentUser.id;
            
            const messageElement = document.createElement('div');
            messageElement.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
            
            const time = formatTime(msg.timestamp);
            
            messageElement.innerHTML = `
                <div class="message-text">${msg.text}</div>
                <div class="message-time">${time}</div>
            `;
            
            messagesContainer.appendChild(messageElement);
        }
        
        // ============================================
        // ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
        // ============================================
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const text = messageInput.value.trim();
            
            if (!text || !currentChat || !currentUser || !db) return;
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© Ø£ÙˆÙ„Ø§Ù‹
            const tempMessage = {
                senderId: currentUser.id,
                senderName: currentUser.name,
                text: text,
                timestamp: new Date().toISOString()
            };
            
            addMessageToUI(tempMessage);
            
            // Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
            messageInput.value = '';
            
            // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„
            setTimeout(() => {
                const messagesContainer = document.getElementById('messagesContainer');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
            
            try {
                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù€ Firebase
                const messageData = {
                    senderId: currentUser.id,
                    senderName: currentUser.name,
                    text: text,
                    timestamp: new Date().toISOString()
                };
                
                await db.collection('chats').doc(currentChat.id)
                    .collection('messages')
                    .add(messageData);
                
                // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
                await db.collection('chats').doc(currentChat.id).update({
                    lastMessage: text,
                    lastMessageTime: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
                
                console.log("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­");
                
                // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª
                const chatIndex = myChats.findIndex(c => c.id === currentChat.id);
                if (chatIndex !== -1) {
                    myChats[chatIndex].lastMessage = text;
                    myChats[chatIndex].lastMessageTime = new Date().toISOString();
                    updateChatsList();
                }
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
                showNotification('âš ï¸ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·');
            }
        }
        
        // ============================================
        // ğŸ”„ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
        // ============================================
        function switchTab(tabName) {
            // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„Ø´Ø§Ø´Ø§Øª
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            document.getElementById(`${tabName}Screen`).classList.add('active');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                
                // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
                if (tab.dataset.tab === 'chat') {
                    tab.style.display = tabName === 'chat' ? 'flex' : 'none';
                }
                
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                }
            });
        }
        
        // ============================================
        // ğŸŒ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        // ============================================
        async function updateOnlineStatus() {
            if (!currentUser || !db) return;
            
            try {
                await db.collection('users').doc(currentUser.id).update({
                    isOnline: true,
                    lastSeen: new Date().toISOString()
                });
            } catch (error) {
                console.warn("âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„:", error.message);
            }
        }
        
        async function updateUserStatus(isOnline) {
            if (!currentUser || !db) return;
            
            try {
                await db.collection('users').doc(currentUser.id).update({
                    isOnline: isOnline,
                    lastSeen: new Date().toISOString()
                });
            } catch (error) {
                console.warn("âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", error.message);
            }
        }
        
        // ============================================
        // âœï¸ ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…
        // ============================================
        async function changeName() {
            const newName = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯:', currentUser.name);
            if (!newName || newName.trim() === currentUser.name) return;
            
            currentUser.name = newName.trim();
            
            // Ø­ÙØ¸ ÙÙŠ localStorage
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // ØªØ­Ø¯ÙŠØ« ÙÙŠ Firebase
            try {
                await db.collection('users').doc(currentUser.id).update({
                    name: newName.trim(),
                    updatedAt: new Date().toISOString()
                });
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
                const myChatsSnapshot = await db.collection('chats')
                    .where('user1', '==', currentUser.id)
                    .get();
                
                const batch = db.batch();
                
                myChatsSnapshot.forEach(doc => {
                    batch.update(doc.ref, { user1Name: newName.trim() });
                });
                
                const myChatsSnapshot2 = await db.collection('chats')
                    .where('user2', '==', currentUser.id)
                    .get();
                
                myChatsSnapshot2.forEach(doc => {
                    batch.update(doc.ref, { user2Name: newName.trim() });
                });
                
                await batch.commit();
                
            } catch (error) {
                console.warn("âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±:", error.message);
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            loadUserData();
            showNotification('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­ âœ¨');
        }
        
        // ============================================
        // ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        // ============================================
        async function logout() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                if (currentUser && db) {
                    try {
                        await db.collection('users').doc(currentUser.id).update({
                            isOnline: false,
                            lastSeen: new Date().toISOString()
                        });
                    } catch (error) {
                        console.warn("âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø±ÙˆØ¬:", error.message);
                    }
                }
                
                // Ø¥ÙŠÙ‚Ø§Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª
                if (unsubscribeUsers) unsubscribeUsers();
                if (unsubscribeChats) unsubscribeChats();
                if (unsubscribeMessages) unsubscribeMessages();
                
                // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                localStorage.removeItem('currentUser');
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
                location.reload();
            }
        }
        
        // ============================================
        // âš¡ Ø¯Ø®ÙˆÙ„ Ø³Ø±ÙŠØ¹ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        // ============================================
        function quickLogin(name) {
            document.getElementById('userName').value = name;
            login();
        }
        
        // ============================================
        // ğŸ¬ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // ØªÙ‡ÙŠØ¦Ø© Firebase Ø£ÙˆÙ„Ø§Ù‹
            initializeFirebase();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    startApp();
                    return;
                } catch (error) {
                    localStorage.removeItem('currentUser');
                }
            }
            
            // Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„ØªØ±ÙƒÙŠØ² Ù„Ø­Ù‚Ù„ Ø§Ù„Ø§Ø³Ù…
            document.getElementById('userName').focus();
            
            // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±
            document.getElementById('userName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
            
            console.log("ğŸš€ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…!");
        });
    </script>
</body>
    </html>
