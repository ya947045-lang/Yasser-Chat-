<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Chat Room</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<div class="chat-container">
  <div class="top-bar">
    <button onclick="logout()">تسجيل خروج</button>
  </div>

  <div id="messages" class="messages"></div>

  <div class="send-box">
    <input type="text" id="messageInput" placeholder="اكتب رسالة..." />
    <button onclick="sendMessage()">إرسال</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut }
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp }
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDLm_HUbnNfRv4ZH9u08VQi7pmZzm1GgRk",
    authDomain: "yasser-chat-6c39c.firebaseapp.com",
    projectId: "yasser-chat-6c39c",
    storageBucket: "yasser-chat-6c39c.firebasestorage.app",
    messagingSenderId: "141483029088",
    appId: "1:141483029088:web:49c20f6f027be755bbc905"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const messagesDiv = document.getElementById("messages");
  const messageInput = document.getElementById("messageInput");

  onAuthStateChanged(auth, user => {
    if (!user) location.href = "index.html";
  });

  window.logout = () => signOut(auth);

  window.sendMessage = async () => {
    if (messageInput.value.trim() === "") return;

    await addDoc(collection(db, "messages"), {
      text: messageInput.value,
      uid: auth.currentUser.uid,
      time: serverTimestamp()
    });

    messageInput.value = "";
  };

  const q = query(collection(db, "messages"), orderBy("time"));
  onSnapshot(q, snapshot => {
    messagesDiv.innerHTML = "";
    snapshot.forEach(doc => {
      const msg = doc.data();
      const div = document.createElement("div");
      div.className = msg.uid === auth.currentUser.uid ? "my-msg" : "other-msg";
      div.textContent = msg.text;
      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
</script>

</body>
</html>
