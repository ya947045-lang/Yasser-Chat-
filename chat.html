<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø´Ø§Øª ÙØ´ÙŠØ®</title>
<link rel="stylesheet" href="style.css">
<script type="module" src="firebaseConfig.js"></script>
</head>
<body>
<div class="chat-container">

  <div class="users-list">
    <h2>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Online</h2>
    <ul id="users"></ul>
  </div>

  <div class="chat-box">
    <div id="messages" class="messages"></div>
    <div class="input-box">
      <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©">
      <button id="sendBtn">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
    <button id="logoutBtn" style="margin-top:10px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>

</div>

<script type="module">
import { db, auth } from "./firebaseConfig.js";
import { collection, doc, addDoc, onSnapshot, serverTimestamp, query, orderBy, updateDoc } from "firebase/firestore";
import { signOut } from "firebase/auth";

const uid = localStorage.getItem("uid");
const name = localStorage.getItem("name");

let currentChatId = null;
const usersList = document.getElementById("users");
const messagesDiv = document.getElementById("messages");
const sendBtn = document.getElementById("sendBtn");
const messageInput = document.getElementById("messageInput");
const logoutBtn = document.getElementById("logoutBtn");

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Online
const usersCol = collection(db, "users");
onSnapshot(usersCol, snapshot => {
  usersList.innerHTML = "";
  snapshot.forEach(docSnap => {
    if(docSnap.id !== uid) {
      const li = document.createElement("li");
      li.textContent = docSnap.data().name + (docSnap.data().online ? " ğŸŸ¢" : " âšª");
      li.addEventListener("click", () => openChat(docSnap.id, docSnap.data().name));
      usersList.appendChild(li);
    }
  });
});

// ÙØªØ­ Ø´Ø§Øª
function openChat(otherUid, otherName) {
  currentChatId = uid < otherUid ? `${uid}_${otherUid}` : `${otherUid}_${uid}`;
  messagesDiv.innerHTML = `<h3>Ø´Ø§Øª Ù…Ø¹ ${otherName}</h3>`;

  const messagesQuery = query(collection(db, "chats", currentChatId, "messages"), orderBy("time"));
  onSnapshot(messagesQuery, snapshot => {
    messagesDiv.innerHTML = `<h3>Ø´Ø§Øª Ù…Ø¹ ${otherName}</h3>`;
    snapshot.forEach(docSnap => {
      const div = document.createElement("div");
      div.className = docSnap.data().senderUid === uid ? "my-message" : "other-message";
      div.innerHTML = docSnap.data().text + (docSnap.data().senderUid === uid ? " âœ”" : "");
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  });
}

// Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
sendBtn.addEventListener("click", async () => {
  const text = messageInput.value.trim();
  if(!text || !currentChatId) return;
  await addDoc(collection(db, "chats", currentChatId, "messages"), {
    text,
    senderUid: uid,
    time: serverTimestamp()
  });
  messageInput.value = "";
});

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
logoutBtn.addEventListener("click", async () => {
  await updateDoc(doc(db, "users", uid), { online: false });
  await signOut(auth);
  localStorage.clear();
  window.location.href = "index.html";
});
</script>
</body>
</html>
